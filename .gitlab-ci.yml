image: eicweb.phy.anl.gov:4567/eic/juggler/juggler:latest

variables:
  JOBS: 1

default:
  timeout: 3 hours
  artifacts:
    expire_in: 1 week 
    paths:
      - results/

stages:
  - gzip
  - nevents
  - timings
  - collect

.gzip:
  stage: gzip
  script:
    - mc config host add S3rw https://dtn01.sdcc.bnl.gov:9000 ${S3RW_ACCESS_KEY} ${S3RW_SECRET_KEY}
    - cat $DATA | grep -v "^\#" | parallel -j $JOBS --colsep "," scripts/gzip_hepmc.sh {1} {2} {3}

.nevents:
  stage: nevents
  script:
    - mc config host add S3 https://dtn01.sdcc.bnl.gov:9000 ${S3_ACCESS_KEY} ${S3_SECRET_KEY}
    - mkdir -p $(dirname results/datasets/nevents/$DATA)
    - cat $DATA | grep -v "^\#" | parallel -j $JOBS --colsep "," scripts/count_events.sh {1} {2} {3} | sort | tee results/datasets/nevents/$DATA

.timings:
  stage: timings
  script:
    - mc config host add S3 https://dtn01.sdcc.bnl.gov:9000 ${S3_ACCESS_KEY} ${S3_SECRET_KEY}
    - mkdir -p $(dirname results/datasets/timings/$DATA)
    #- cat results/datasets/nevents/$DATA | grep -v "^\#" | head -n 1 | parallel -j $JOBS --colsep "," scripts/determine_timing.sh {1} {2} {3} | sort | tee results/datasets/timings/$DATA
    - echo "EVGEN/DIS/NC/5x41/minQ2=1/pythia8NCDIS_5x41_minQ2=1_beamEffects_xAngle=-0.025_hiDiv_vtxfix_1.hepmc,998651,44.787289338,1.30609" | tee results/datasets/timings/$DATA
    - |
      # read timing for first line
      cat results/datasets/timings/$DATA | grep -v "^\#" | head -n 1 | while IFS="," read file nevents first_dt0 first_dt1 ; do
        if [ -n "${first_dt0}" -a -n "${first_dt1}" ] ; then
          export dt0=${first_dt0}
          export dt1=${first_dt1}
          echo "export --- Using $dt0 and $dt1"
        fi
        echo "fi --- Using $dt0 and $dt1"
      done
      echo "done --- Using $dt0 and $dt1"
      # then apply to all lines in file
      cat results/datasets/nevents/$DATA | grep -v "^\#" | while IFS="," read file nevents lines_per_event ; do
        echo "${file},${nevents},${dt0},${dt1}"
      done | tee results/datasets/timings/$DATA

.collect:
  stage: collect
  script:
    - rm -rf results/logs/
    - ls -Rlh results/datasets/

include:
  - local: 'DIS/config.yml'
#  - local: 'EXCLUSIVE/config.yml'
#  - local: 'SIDIS/config.yml'
#  - local: 'SINGLE/config.yml'
#  - local: 'SR/config.yml'

collect:
  extends: .collect
  needs:
    - "DIS:collect"
#    - "EXCLUSIVE:collect"
#    - "SIDIS:collect"
#    - "SINGLE:collect"
#    - "SR:collect"
