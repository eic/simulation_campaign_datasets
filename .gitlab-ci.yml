image: eicweb.phy.anl.gov:4567/eic/juggler/juggler:latest

test:
  stage: test
  tags:
    - s3
  artifacts:
    expire_in: 1 week 
    paths:
      - results/
  script:
    - mc config host add S3 https://dtn01.sdcc.bnl.gov:9000 ${S3_ACCESS_KEY} ${S3_SECRET_KEY}
    - grep -v ^\# $DATA | awk -F',' '{print($1)}' | head -n 5 | while read data ; do
        mkdir -p $(dirname ${data/EVGEN/EVGEN\/CI}) ;
        mc head -n 1000 S3/eictest/ATHENA/$data > ${data/EVGEN/EVGEN\/CI} ;
        nevents=$(grep ^E ${data/EVGEN/EVGEN\/CI} | wc -l) ;
        test $nevents -gt 0 ;
        mkdir -p $(dirname results/${data/EVGEN/EVGEN\/CI}.time) ;
        /usr/bin/time -o results/${data/EVGEN/EVGEN\/CI}.time /opt/campaigns/hepmc3/scripts/run.sh ${data/EVGEN/EVGEN\/CI} $((nevents-1)) ;
      done
  parallel:
    matrix:
      - DATA: ["DVCS.csv", "DIS.csv", "SIDIS.csv", "TCS.csv"]
